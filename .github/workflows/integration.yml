name: Sync to Parent Repository

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:  
  sync-to-parent:
    name: Sync Changes to Parent Repository
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the forked repository (salmorejo-hub-1)
    - name: Checkout salmorejo-hub-1 repository
      uses: actions/checkout@v3
      with:
        ref: main

    # Step 2: Add the parent repository as a remote
    - name: Add parent repository
      run: |
        git remote add parent https://github.com/salmorejo-hub/uvlhub.git
        git fetch parent develop

    # Step 3: Attempt to merge changes from salmorejo-hub-1/main to parent/develop
    - name: Attempt to merge into parent/develop
      run: |
        git checkout -b develop-parent parent/develop
        git merge --no-ff main || echo "Merge conflict detected."

    # Step 4: Check if there are merge conflicts
    - name: Check for merge conflicts
      run: |
        if git ls-files -u | grep -q '.'; then
          echo "Merge conflict detected. Please resolve manually." && exit 1
        fi

    # Step 5: Push changes to the parent repository
    - name: Push changes to parent/develop
      run: |
        git push https://${{ secrets.PARENT_REPO_TOKEN }}@github.com/salmorejo-hub/uvlhub.git HEAD:develop

    # Step 6: Notify user if the merge was successful
    - name: Notify success
      if: success()
      run: |
        echo "The merge was successful and changes were pushed to parent/develop."

    # Step 7: Notify user if the merge failed
    - name: Notify failure
      if: failure()
      run: |
        echo "The merge failed due to conflicts. Please resolve conflicts manually and try again."
